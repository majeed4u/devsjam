

pipeline {
    agent any

    environment {
        IMAGE_NAME = "ghcr.io/majeed4u/devjams-server"
        IMAGE_TAG = "${env.BUILD_ID}"
    }

    stages {
        stage('Pull from Git') {
            steps {
                git branch: 'main', credentialsId: 'github_pat_cred', url: 'https://github.com/majeed4u/devsjam.git'
            }
        }

        stage('Login and build image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'ghcr_cred', passwordVariable: 'GITHUB_TOKEN', usernameVariable: 'GITHUB_USERNAME')]) {
                    sh """
                    # Login to GHCR
                    echo ${GITHUB_TOKEN} | docker login ghcr.io -u ${GITHUB_USERNAME} --password-stdin
                    
                    docker build -f apps/server/Dockerfile.server -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        // stage('Update Tag') {
        //     steps {
        //         withCredentials([usernamePassword(credentialsId: 'github_cred', passwordVariable: 'GITHUB_PASSWORD', usernameVariable: 'GITHUB_USERNAME')]) {
        //             git branch: 'main', credentialsId: 'github_cred', url: 'https://github.com/majeed4u/devsjam.gitt'

        //             sh """
        //             # Update the tag in the YAML file
        //             sed -i 's/tag: [0-9]\\+/tag: ${IMAGE_TAG}/' test-login-app/values.yaml

        //             # Force add and commit if there are changes
        //             git add test-login-app/values.yaml
        //             git commit -m "Updated login tag to ${IMAGE_TAG}" || echo "No changes to commit"

        //             # Ensure git can authenticate using the stored credentials
        //             git config --global credential.helper 'store'
        //             echo "machine gitlab.local.majedtec.com login ${GITLAB_USERNAME} password ${GITLAB_PASSWORD}" > ~/.netrc
        //             chmod 600 ~/.netrc

        //             # Push the changes
        //             git push https://gitea.local.majedtec.com/gitadmin/gitea_manifest.git
        //             """
        //         }
        //     }
        // }
    }
}
