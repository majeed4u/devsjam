def SHOULD_BUILD = true

pipeline {
    agent any
    environment {
        IMAGE_NAME = "gitea.mjdev.dev/gitadmin/registery/devjams-server"
        IMAGE_TAG  = "${env.BUILD_ID}"
    }
    stages {

        stage('Skip irrelevant changes') {
            steps {
                script {
                    def changed = sh(script: 'git diff --name-only HEAD^ HEAD 2>/dev/null || true', returnStdout: true).trim()
                    echo "Changed files:\n${changed}"
                    def lines = changed.split('\n')
                    def relevant = lines.any { (it.startsWith('apps/server/') && !it.endsWith('Jenkinsfile')) || it.startsWith('packages/api/') || it.startsWith('packages/db/') }
                    if (!relevant) {
                        echo 'No server-related files changed; skipping server build.'
                        SHOULD_BUILD = false
                    }
                }
            }
        }

        stage('Pull from Git') {
            when { expression { return SHOULD_BUILD } }
            steps {
                git branch: 'main',
                    credentialsId: 'github_pat_cred',
                    url: 'https://github.com/majeed4u/devsjam.git'
            }
        }

        stage('Login and build image') {
            when { expression { return SHOULD_BUILD } }
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'gitea_cred',
                    passwordVariable: 'GITEA_TOKEN',
                    usernameVariable: 'GITEA_USERNAME'
                )]) {
                    sh """
                        echo ${GITEA_TOKEN} | docker login gitea.mjdev.dev -u ${GITEA_USERNAME} --password-stdin
                        docker build -f apps/server/Dockerfile.server -t ${IMAGE_NAME}:${IMAGE_TAG} .
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update Tag') {
            when { expression { return SHOULD_BUILD } }
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'ghcr_cred',
                    passwordVariable: 'GITHUB_PASSWORD',
                    usernameVariable: 'GITHUB_USERNAME'
                )]) {
                    git branch: 'main',
                        credentialsId: 'ghcr_cred',
                        url: 'https://github.com/majeed4u/devjams-k8s.git'
                    sh """
                        git config --global user.email "jamodah20@gmail.com"
                        git config --global user.name "majeed4u"
                    """
                    retry(5) {
                        sh """
                            git pull --rebase origin main
                            sed -i 's|^  tag:.*|  tag: "${IMAGE_TAG}"|' server/values.yaml
                            git add server/values.yaml
                            git commit -m "Updated server tag to '${IMAGE_TAG}' [ci skip]" || true
                            git push https://\${GITHUB_USERNAME}:\${GITHUB_PASSWORD}@github.com/majeed4u/devjams-k8s.git
                        """
                    }
                }
            }
        }
    }
}