pipeline {
    agent any
    environment {
        IMAGE_NAME = "gitea.mjdev.dev/gitadmin/registery/devjams-server"
        IMAGE_TAG  = "${env.BUILD_ID}"
    }
    stages {

        stage('Check commit message') {
            steps {
                script {
                    // Get the latest commit message from git directly (more reliable than changeSets)
                    def msg = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    echo "Commit message: ${msg}"

                    if (msg.contains('[ci skip]')) {
                        echo 'Triggered by self-update commit ([ci skip]). Aborting.'
                        currentBuild.result = 'SUCCESS'
                        // This actually stops the pipeline in declarative syntax:
                        error('[ci skip] detected — stopping pipeline intentionally.')
                    }
                }
            }
        }

        stage('Check relevant paths') {
            steps {
                script {
                    def changed = sh(
                        script: 'git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD 2>/dev/null || echo "UNKNOWN"',
                        returnStdout: true
                    ).trim()

                    echo "Changed files:\n${changed}"

                    // Check if ANY changed file is under the relevant paths
                    def relevant = changed.split('\n').any { file ->
                        file.startsWith('apps/server/') || file.startsWith('packages/api/')
                    }

                    if (!relevant) {
                        echo 'No backend-related files changed. Skipping build.'
                        currentBuild.result = 'SUCCESS'
                        error('No relevant changes — stopping pipeline intentionally.')
                    }
                }
            }
        }

        stage('Pull from Git') {
            steps {
                git branch: 'main',
                    credentialsId: 'github_pat_cred',
                    url: 'https://github.com/majeed4u/devsjam.git'
            }
        }

        stage('Login and build image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'gitea_cred',
                    passwordVariable: 'GITEA_TOKEN',
                    usernameVariable: 'GITEA_USERNAME'
                )]) {
                    sh """
                        echo ${GITEA_TOKEN} | docker login gitea.mjdev.dev -u ${GITEA_USERNAME} --password-stdin
                        docker build -f apps/server/Dockerfile.server -t ${IMAGE_NAME}:${IMAGE_TAG} .
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update Tag') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'ghcr_cred',
                    passwordVariable: 'GITHUB_PASSWORD',
                    usernameVariable: 'GITHUB_USERNAME'
                )]) {
                    git branch: 'main',
                        credentialsId: 'ghcr_cred',
                        url: 'https://github.com/majeed4u/devsjam.git'
                    sh '''
                        git config --global user.email "jamodah20@gmail.com"
                        git config --global user.name "majeed4u"

                        sed -i 's|^ tag:.*| tag: "'"${IMAGE_TAG}"'"|' k8s/server/values.yaml

                        git add k8s/server/values.yaml

                        # Only commit+push if there's actually a change
                        if git diff --cached --quiet; then
                            echo "No changes to commit."
                        else
                            git commit -m "Updated server tag to ${IMAGE_TAG} [ci skip]"
                            git push https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/majeed4u/devsjam.git
                        fi
                    '''
                }
            }
        }
    }

    post {
        failure {
            script {
                // Don't mark intentional skips as failures
                if (currentBuild.result == 'SUCCESS') {
                    echo 'Pipeline was intentionally stopped early — not a real failure.'
                }
            }
        }
    }
}