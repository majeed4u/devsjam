pipeline {
    agent any

    environment {
        IMAGE_NAME = "gitea.mjdev.dev/gitadmin/registery/devjams-web"
        IMAGE_TAG = "${env.BUILD_ID}"
    }

    stages {
        stage('Self-trigger check') {
            steps {
                script {
                    def skip = currentBuild.changeSets
                        .collect { it.items }
                        .flatten()
                        .any { it.msg =~ /\[ci skip\]/ }
                    if (skip) {
                        echo 'Build triggered by selfâ€‘update commit ([ci skip]); aborting.'
                        currentBuild.result = 'SUCCESS'
                        error('Aborting due to self-trigger')
                    }
                }
            }
        }

        stage('Skip irrelevant paths') {
            steps {
                script {
                    def changed = sh(script: 'git diff --name-only HEAD^ HEAD || true', returnStdout: true).trim()
                    echo "Files changed:\n${changed}"
                    if (!(changed =~ /^(apps\/web)/)) {
                        echo 'No frontend-related files modified; skipping build.'
                        currentBuild.result = 'SUCCESS'
                        error('Irrelevant change')
                    }
                }
            }
        }

        stage('Pull from Git') {
            steps {
                git branch: 'main', credentialsId: 'github_pat_cred', url: 'https://github.com/majeed4u/devsjam.git'
            }
        }

        stage('Login and build image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'gitea_cred', passwordVariable: 'GITEA_TOKEN', usernameVariable: 'GITEA_USERNAME')]) {
                    sh """
                    # Login to Gitea
                    echo ${GITEA_TOKEN} | docker login gitea.mjdev.dev -u ${GITEA_USERNAME} --password-stdin
                    
                    docker build -f apps/web/Dockerfile.web -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update Tag') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'ghcr_cred', passwordVariable: 'GITHUB_PASSWORD', usernameVariable: 'GITHUB_USERNAME')]) {
                    git branch: 'main', credentialsId: 'ghcr_cred', url: 'https://github.com/majeed4u/devsjam.git'

                    sh '''
                    # Set git identity (required for commits)
                    git config --global user.email "jamodah20@gmail.com"
                    git config --global user.name "majeed4u"

                    # Update the tag in the YAML file (handles quoted version like "1.0.0")
                    sed -i 's/tag: "[0-9.]*"/tag: "'"${IMAGE_TAG}"'"/' k8s/web/values.yaml

                    # Add and commit if there are changes (include skip token to prevent webhook looping)
                    git add k8s/web/values.yaml
                    git commit -m "Updated web tag to '${IMAGE_TAG}' [ci skip]" || echo "No changes to commit"

                    # Push using credentials in URL
                    git push https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/majeed4u/devsjam.git
                    '''
                }
            }
        }
    }
}
