


pipeline {
    agent any

    environment {
        IMAGE_NAME = "gitea.mjdev.dev/gitadmin/registery/devjams-server"
        IMAGE_TAG = "${env.BUILD_ID}"
    }

    stages {
        stage('Self-trigger check') {
            steps {
                script {
                    // examine commit messages to see if this build was started by our own tag update
                    def skip = currentBuild.changeSets
                        .collect { it.items }
                        .flatten()
                        .any { it.msg =~ /\[ci skip\]/ }
                    if (skip) {
                        echo 'Build triggered by selfâ€‘update commit ([ci skip]); aborting.'
                        currentBuild.result = 'SUCCESS'
                        // throwing to stop the pipeline
                        error('Aborting due to self-trigger')
                    }
                }
            }
        }

        stage('Skip irrelevant paths') {
            steps {
                script {
                    // only run backend pipeline when relevant files changed
                    def changed = sh(script: 'git diff --name-only HEAD^ HEAD || true', returnStdout: true).trim()
                    echo "Files changed:\n${changed}"
                    if (!(changed =~ /^(apps\/server|packages\/api)\//)) {
                        echo 'No backend-related files modified; skipping build.'
                        currentBuild.result = 'SUCCESS'
                        error('Irrelevant change')
                    }
                }
            }
        }

        stage('Pull from Git') {
            steps {
                git branch: 'main', credentialsId: 'github_pat_cred', url: 'https://github.com/majeed4u/devsjam.git'
            }
        }

        stage('Login and build image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'gitea_cred', passwordVariable: 'GITEA_TOKEN', usernameVariable: 'GITEA_USERNAME')]) {
                    sh """
                    # Login to Gitea
                    echo ${GITEA_TOKEN} | docker login gitea.mjdev.dev -u ${GITEA_USERNAME} --password-stdin
                    
                    docker build -f apps/server/Dockerfile.server -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update Tag') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'ghcr_cred', passwordVariable: 'GITHUB_PASSWORD', usernameVariable: 'GITHUB_USERNAME')]) {
                    git branch: 'main', credentialsId: 'ghcr_cred', url: 'https://github.com/majeed4u/devsjam.git'

                    sh '''
                    # Set git identity (required for commits)
                    git config --global user.email "jamodah20@gmail.com"
                    git config --global user.name "majeed4u"

                    # Update the tag in the YAML file.  We'll simply rewrite the entire
                    # `tag:` line which avoids any tricky escaping in the Jenkinsfile.
                    sed -i 's|^  tag:.*|  tag: "'"${IMAGE_TAG}"'"|' k8s/server/values.yaml
                    # if somehow the closing quote is missing, append it
                    sed -i '/^  tag: "[^"]*$/ s/$/"/' k8s/server/values.yaml

                    # Add and commit if there are changes (include skip token to prevent webhook looping)
                    git add k8s/server/values.yaml
                    git commit -m "Updated login tag to '${IMAGE_TAG}' [ci skip]" || echo "No changes to commit"

                    # Push using credentials in URL
                    git push https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/majeed4u/devsjam.git
                    '''
                }
            }
        }

        
    }
}
